<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="utry.data.modular.technicalQuality.dao.TechnicalQualityCopyDao">



    <select id="selectEngineer" parameterType ="utry.data.modular.technicalQuality.dto.EngineerQueryDTO" resultType="utry.data.modular.technicalQuality.dto.EngineerCopyDTO">
        SELECT tt.* FROM(SELECT
        t.storeName,t.engineerName,t.engineerId,t.adminName,t.productCategory,
        t.productType,t.productCategoryCode,t.productTypeCode,
        CONCAT(CAST(0+CAST(IFNULL(ROUND(t.eligible / t.total*100,2 ),0) AS CHAR)AS CHAR),'%') AS repairRate,
        IFNULL(t.eligible, 0) AS eligible,
        IFNULL(t.total, 0) AS total,
        IFNULL(t.total - t.eligible, 0) AS unEligible
        FROM
        (
        SELECT
        a.storeName,
        a.engineerName,
        a.engineerId,
        e.adminName,
        a.productCategory,
        a.productType,
        a.productTypeCode,
        a.productCategoryCode,
        COUNT(a.dispatchingOrder) AS total,
        SUM(
        a.repairEligible
        ) AS eligible
        FROM
        t_region_dispatching_detail a FORCE INDEX(in_t)
        LEFT JOIN t_district_accounting e ON e.areaCode = a.accountingAreaCode
        WHERE a.serviceType IN ("非上门维修","维修") AND a.repairEligible IS NOT NULL AND a.systemState NOT IN ('已作废','已关闭','申请作废')
        AND a.dispatchingSource NOT IN ('自接','营销中心','前置渠道')
        <if test="engineers != null and engineers.size > 0">
            AND a.engineerId IN
            <foreach collection="engineers" item="engineerId" open="(" separator="," close=")">
                #{engineerId}
            </foreach>
        </if>
        <if test="(list != null and list.size > 0) or (modelList != null and modelList.size > 0 ) or (productCategoryList != null and productCategoryList.size > 0)">
            AND( 1=2
            <if test="list != null and list.size > 0">
                OR a.productTypeCode IN
                <foreach collection="list" item="productTypeCode" open="(" separator="," close=")">
                    #{productTypeCode}
                </foreach>
            </if>
            <if test="modelList != null and modelList.size > 0">
                OR a.productModel IN
                <foreach collection="modelList" item="productModel" open="(" separator="," close=")">
                    #{productModel}
                </foreach>
            </if>
            <if test="productCategoryList != null and productCategoryList.size > 0">
                OR a.productCategoryCode IN
                <foreach collection="productCategoryList" item="productCategoryCode" open="(" separator="," close=")">
                    #{productCategoryCode}
                </foreach>
            </if>
            )
        </if>
        <if test="startTime != '' and startTime != null">
            AND a.dispatchingTime &gt;= #{startTime}
        </if>
        <if test="endTime != '' and endTime != null">
            AND a.dispatchingTime &lt;= #{endTime}
        </if>
        AND a.dispatchingTime IS NOT NULL
        GROUP BY
        a.engineerId,a.productCategoryCode,
        a.productTypeCode
        ) t
        ) tt
        WHERE 1 = 1
    </select>


    <select id="selectEngineers" parameterType ="utry.data.modular.technicalQuality.dto.EngineerDTO"
            resultType="java.lang.String">
        SELECT tt.engineerId FROM(SELECT
        t.storeName,t.engineerName,t.engineerId,t.adminName,
        CONCAT(CAST(0+CAST(IFNULL(ROUND(t.eligible / t.total*100,2 ),0) AS CHAR)AS CHAR),'%') AS repairRate,
        CONCAT(IFNULL(t.eligible, 0),'') AS eligible,
        CONCAT(IFNULL(t.total, 0),'') AS total,
        CONCAT(IFNULL(t.total - t.eligible, 0),'') AS unEligible
        FROM
        (
        SELECT
        a.storeName,
        a.engineerName,
        a.engineerId,
        e.adminName,
        COUNT(a.dispatchingOrder) AS total,
        SUM(
        a.repairEligible
        ) AS eligible
        FROM
        t_region_dispatching_detail a FORCE INDEX(in_t)
        LEFT JOIN t_district_accounting e ON e.areaCode = a.accountingAreaCode
        WHERE a.serviceType IN ("非上门维修","维修") AND a.repairEligible IS NOT NULL AND a.systemState NOT IN ('已作废','已关闭','申请作废')
        AND a.dispatchingSource NOT IN ('自接','营销中心','前置渠道')
        AND a.engineerId IS NOT NULL AND a.engineerId != ""
        <if test="(list != null and list.size > 0) or (modelList != null and modelList.size > 0 ) or (productCategoryList != null and productCategoryList.size > 0)">
            AND( 1=2
            <if test="list != null and list.size > 0">
                OR a.productTypeCode IN
                <foreach collection="list" item="productTypeCode" open="(" separator="," close=")">
                    #{productTypeCode}
                </foreach>
            </if>
            <if test="modelList != null and modelList.size > 0">
                OR a.productModel IN
                <foreach collection="modelList" item="productModel" open="(" separator="," close=")">
                    #{productModel}
                </foreach>
            </if>
            <if test="productCategoryList != null and productCategoryList.size > 0">
                OR a.productCategoryCode IN
                <foreach collection="productCategoryList" item="productCategoryCode" open="(" separator="," close=")">
                    #{productCategoryCode}
                </foreach>
            </if>
            )
        </if>
        <if test="startTime != '' and startTime != null">
            AND a.dispatchingTime &gt;= #{startTime}
        </if>
        <if test="endTime != '' and endTime != null">
            AND a.dispatchingTime &lt;= #{endTime}
        </if>
        AND a.dispatchingTime IS NOT NULL
        GROUP BY
        a.engineerId
        ) t
        ) tt
        WHERE 1 = 1
        <if test="engineerName != '' and engineerName!= null and engineerName.textType != '' and engineerName.textType != null and engineerName.textType == '0'.toString()">
            AND engineerName = #{engineerName.value}
        </if>
        <if test="engineerName != '' and engineerName!= null and engineerName.textType != '' and engineerName.textType != null and engineerName.textType == '1'.toString()">
            AND engineerName LIKE CONCAT('%',#{engineerName.value},'%')
        </if>
        <if test="engineerName != '' and engineerName!= null and engineerName.textType != '' and engineerName.textType != null and engineerName.textType == '2'.toString()">
            AND engineerName &lt;&gt; #{engineerName.value}
        </if>
        <if test="engineerId != '' and engineerId!= null and engineerId.textType != '' and engineerId.textType != null and engineerId.textType == '0'.toString()">
            AND engineerId = #{engineerId.value}
        </if>
        <if test="engineerId != '' and engineerId!= null and engineerId.textType != '' and engineerId.textType != null and engineerId.textType == '1'.toString()">
            AND engineerId LIKE CONCAT('%',#{engineerId.value},'%')
        </if>
        <if test="engineerId != '' and engineerId!= null and engineerId.textType != '' and engineerId.textType != null and engineerId.textType == '2'.toString()">
            AND engineerId &lt;&gt; #{engineerId.value}
        </if>
        <if test="storeName != '' and storeName!= null and storeName.textType != '' and storeName.textType != null and storeName.textType == '0'.toString()">
            AND storeName = #{storeName.value}
        </if>
        <if test="storeName != '' and storeName!= null and storeName.textType != '' and storeName.textType != null and storeName.textType == '1'.toString()">
            AND storeName LIKE CONCAT('%',#{storeName.value},'%')
        </if>
        <if test="storeName != '' and storeName!= null and storeName.textType != '' and storeName.textType != null and storeName.textType == '2'.toString()">
            AND storeName &lt;&gt; #{storeName.value}
        </if>
        <if test="adminName != '' and adminName!= null and adminName.textType != '' and adminName.textType != null and adminName.textType == '0'.toString()">
            AND adminName = #{adminName.value}
        </if>
        <if test="adminName != '' and adminName!= null and adminName.textType != '' and adminName.textType != null and adminName.textType == '1'.toString()">
            AND adminName LIKE CONCAT('%',#{adminName.value},'%')
        </if>
        <if test="adminName != '' and adminName!= null and adminName.textType != '' and adminName.textType != null and adminName.textType == '2'.toString()">
            AND adminName &lt;&gt; #{adminName.value}
        </if>
        <if test="repairRate != '' and repairRate!= null and repairRate.numberType != '' and repairRate.numberType != null">
            AND CAST(0+CAST(IFNULL(ROUND((eligible+0) / (total+0)*100,2 ),0) AS CHAR)AS CHAR) ${repairRate.numberType} #{repairRate.value}+0
        </if>
        <if test="total != '' and total!= null and total.numberType != '' and total.numberType != null">
            AND total+0 ${total.numberType} #{total.value}+0
        </if>
        <if test="eligible != '' and eligible!= null and eligible.numberType != '' and eligible.numberType != null">
            AND eligible+0 ${eligible.numberType} #{eligible.value}+0
        </if>
        <if test="unEligible != '' and unEligible!= null and unEligible.numberType != '' and unEligible.numberType != null">
            AND unEligible+0 ${unEligible.numberType} #{unEligible.value}+0
        </if>
        <if test="repairRate != '' and repairRate!= null and repairRate.sort != '' and repairRate.sort != null">
            ORDER BY 0+repairRate ${repairRate.sort}
        </if>
        <if test="total != '' and total!= null and total.sort != '' and total.sort != null">
            ORDER BY 0+total ${total.sort}
        </if>
        <if test="eligible != '' and eligible!= null and eligible.sort != '' and eligible.sort != null">
            ORDER BY 0+eligible ${eligible.sort}
        </if>
        <if test="unEligible != '' and unEligible!= null and unEligible.sort != '' and unEligible.sort != null">
            ORDER BY 0+unEligible ${unEligible.sort}
        </if>
        <if test="repairRate.sort == '' and total.sort == '' and eligible.sort == '' and unEligible.sort == ''">
            ORDER BY engineerId DESC
        </if>
        <if test="number > 0">
            LIMIT #{number}
        </if>
    </select>

    <select id="selectApprovalDuration" resultType="utry.data.modular.technicalQuality.dto.ApprovalDurationDTO" parameterType="utry.data.modular.technicalQuality.dto.ApprovalDurationQueryDTO">
        SELECT tt.* FROM(SELECT
        CONCAT(
        IFNULL(
        ROUND((t.time), 2),
        0
        ),
        ''
        ) AS auditDuration,
        t.*
        FROM
        (
        SELECT
        TIMESTAMPDIFF(
        SECOND,
        submitTime,
        IF(systemState="已提交",NOW(),auditFinishTime)
        ) AS `time`,
        submitTime,
        manageNumber,
        productTypeCode,
        productCategoryCode,
        SUBSTRING_INDEX(documentDate, ' ', 1) AS documentDate,
        systemState,
        serviceNumber,
        serviceStoreName,
        productCategory,
        productSeries,
        productModel,
        factoryName,
        manufacturingDate,
        purchaseDate,
        productSymptom
        FROM
        t_quality_feedback
        WHERE 1=1
        <if test="(list != null and list.size > 0) or (modelList != null and modelList.size > 0 ) or (productCategoryList != null and productCategoryList.size > 0)">
            AND( 1=2
            <if test="list != null and list.size > 0">
                OR productTypeCode IN
                <foreach collection="list" item="productTypeCode" open="(" separator="," close=")">
                    #{productTypeCode}
                </foreach>
            </if>
            <if test="modelList != null and modelList.size > 0">
                OR productModel IN
                <foreach collection="modelList" item="productModel" open="(" separator="," close=")">
                    #{productModel}
                </foreach>
            </if>
            <if test="productCategoryList != null and productCategoryList.size > 0">
                OR productCategoryCode IN
                <foreach collection="productCategoryList" item="productCategoryCode" open="(" separator="," close=")">
                    #{productCategoryCode}
                </foreach>
            </if>
            )
        </if>
        <if test="startTime != '' and startTime != null">
            AND SUBSTRING_INDEX(documentDate, ' ', 1) &gt;= #{startTime}
        </if>
        <if test="endTime != '' and endTime != null">
            AND SUBSTRING_INDEX(documentDate, ' ', 1) &lt;= #{endTime}
        </if>
        ) t
        <if test="ifException != '' and ifException != null and ifException != '-1'.toString()">
            WHERE t.submitTime IS NOT NULL AND t.submitTime != ''
        </if>
        )tt
        HAVING 1=1
        <if test="ifException != '' and ifException != null and ifException != '-1'.toString()">
            AND auditDuration &gt;= #{ifException} + 0
        </if>
        <if test="systemState != '' and systemState!= null and systemState.textType != '' and systemState.textType != null and systemState.textType == '0'.toString()">
            AND systemState = #{systemState.value}
        </if>
        <if test="systemState != '' and systemState!= null and systemState.textType != '' and systemState.textType != null and systemState.textType == '1'.toString()">
            AND systemState LIKE CONCAT('%',#{systemState.value},'%')
        </if>
        <if test="systemState != '' and systemState!= null and systemState.textType != '' and systemState.textType != null and systemState.textType == '2'.toString()">
            AND systemState &lt;&gt; #{systemState.value}
        </if>
        <if test="manageNumber != '' and manageNumber!= null and manageNumber.textType != '' and manageNumber.textType != null and manageNumber.textType == '0'.toString()">
            AND manageNumber = #{manageNumber.value}
        </if>
        <if test="manageNumber != '' and manageNumber!= null and manageNumber.textType != '' and manageNumber.textType != null and manageNumber.textType == '1'.toString()">
            AND manageNumber LIKE CONCAT('%',#{manageNumber.value},'%')
        </if>
        <if test="manageNumber != '' and manageNumber!= null and manageNumber.textType != '' and manageNumber.textType != null and manageNumber.textType == '2'.toString()">
            AND manageNumber &lt;&gt; #{manageNumber.value}
        </if>
        <if test="serviceNumber != '' and serviceNumber!= null and serviceNumber.textType != '' and serviceNumber.textType != null and serviceNumber.textType == '0'.toString()">
            AND serviceNumber = #{serviceNumber.value}
        </if>
        <if test="serviceNumber != '' and serviceNumber!= null and serviceNumber.textType != '' and serviceNumber.textType != null and serviceNumber.textType == '1'.toString()">
            AND serviceNumber LIKE CONCAT('%',#{serviceNumber.value},'%')
        </if>
        <if test="serviceNumber != '' and serviceNumber!= null and serviceNumber.textType != '' and serviceNumber.textType != null and serviceNumber.textType == '2'.toString()">
            AND serviceNumber &lt;&gt; #{serviceNumber.value}
        </if>
        <if test="serviceStoreName != '' and serviceStoreName!= null and serviceStoreName.textType != '' and serviceStoreName.textType != null and serviceStoreName.textType == '0'.toString()">
            AND serviceStoreName = #{serviceStoreName.value}
        </if>
        <if test="serviceStoreName != '' and serviceStoreName!= null and serviceStoreName.textType != '' and serviceStoreName.textType != null and serviceStoreName.textType == '1'.toString()">
            AND serviceStoreName LIKE CONCAT('%',#{serviceStoreName.value},'%')
        </if>
        <if test="serviceStoreName != '' and serviceStoreName!= null and serviceStoreName.textType != '' and serviceStoreName.textType != null and serviceStoreName.textType == '2'.toString()">
            AND serviceStoreName &lt;&gt; #{serviceStoreName.value}
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '0'.toString()">
            AND productCategory = #{productCategory.value}
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '1'.toString()">
            AND productCategory LIKE CONCAT('%',#{productCategory.value},'%')
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '2'.toString()">
            AND productCategory &lt;&gt; #{productCategory.value}
        </if>
        <if test="productSeries != '' and productSeries!= null and productSeries.textType != '' and productSeries.textType != null and productSeries.textType == '0'.toString()">
            AND productSeries = #{productSeries.value}
        </if>
        <if test="productSeries != '' and productSeries!= null and productSeries.textType != '' and productSeries.textType != null and productSeries.textType == '1'.toString()">
            AND productSeries LIKE CONCAT('%',#{productSeries.value},'%')
        </if>
        <if test="productSeries != '' and productSeries!= null and productSeries.textType != '' and productSeries.textType != null and productSeries.textType == '2'.toString()">
            AND productSeries &lt;&gt; #{productSeries.value}
        </if>
        <if test="productModel != '' and productModel!= null and productModel.textType != '' and productModel.textType != null and productModel.textType == '0'.toString()">
            AND productModel = #{productModel.value}
        </if>
        <if test="productModel != '' and productModel!= null and productModel.textType != '' and productModel.textType != null and productModel.textType == '1'.toString()">
            AND productModel LIKE CONCAT('%',#{productModel.value},'%')
        </if>
        <if test="productModel != '' and productSeries!= null and productModel.textType != '' and productModel.textType != null and productModel.textType == '2'.toString()">
            AND productModel &lt;&gt; #{productModel.value}
        </if>
        <if test="factoryName != '' and factoryName!= null and factoryName.textType != '' and factoryName.textType != null and factoryName.textType == '0'.toString()">
            AND factoryName = #{factoryName.value}
        </if>
        <if test="factoryName != '' and factoryName!= null and factoryName.textType != '' and factoryName.textType != null and factoryName.textType == '1'.toString()">
            AND factoryName LIKE CONCAT('%',#{factoryName.value},'%')
        </if>
        <if test="factoryName != '' and factoryName!= null and factoryName.textType != '' and factoryName.textType != null and factoryName.textType == '2'.toString()">
            AND factoryName &lt;&gt; #{factoryName.value}
        </if>
        <if test="documentDate != null and documentDate.type != '' and documentDate.type != null and documentDate.type=='0'.toString()">
            AND SUBSTRING_INDEX(documentDate, ' ', 1) <![CDATA[ >= ]]> #{documentDate.startDate} AND SUBSTRING_INDEX(documentDate, ' ', 1) <![CDATA[ <= ]]> #{documentDate.endDate}
        </if>
        <if test="documentDate != null and documentDate.type != '' and documentDate.type != null and documentDate.type != null and documentDate.type=='1'.toString()">
            AND SUBSTRING_INDEX(documentDate, ' ', 1) <![CDATA[ <= ]]> #{documentDate.startDate}
        </if>
        <if test="documentDate != null and documentDate.type != '' and documentDate.type != null and documentDate.type != null and documentDate.type=='2'.toString()">
            AND SUBSTRING_INDEX(documentDate, ' ', 1) <![CDATA[ >= ]]> #{documentDate.startDate}
        </if>
        <if test="documentDate != null and documentDate.type != '' and documentDate.type != null and documentDate.type=='3'.toString()">
            AND SUBSTRING_INDEX(documentDate, ' ', 1) = #{documentDate.startDate}
        </if>
        <if test="auditDuration != '' and auditDuration!= null and auditDuration.numberType != '' and auditDuration.numberType != null">
            AND ROUND(`time`/60) ${auditDuration.numberType} #{auditDuration.value}+0
        </if>
        <if test="documentDate != '' and documentDate!= null and documentDate.sort != '' and documentDate.sort != null">
            ORDER BY documentDate ${documentDate.sort}
        </if>
        <if test="auditDuration != '' and auditDuration!= null and auditDuration.sort != '' and auditDuration.sort != null">
            ORDER BY 0+`time` ${auditDuration.sort}
        </if>
        <if test="documentDate.sort == '' and auditDuration.sort == ''">
            ORDER BY manageNumber DESC
        </if>
        <if test="number > 0">
            LIMIT #{number}
        </if>
    </select>

    <select id="selectCompletionRate" parameterType ="utry.data.modular.technicalQuality.dto.CompletionRateQueryDTO" resultType="utry.data.modular.technicalQuality.dto.CompletionRateDTO">
        SELECT tt.productCategory,tt.productCategoryCode,tt.`count`,tt.completionRate,GROUP_CONCAT(htha.RealName)AS `name` FROM(SELECT
        p.productCategory,
        p.productCategoryCode,
        COUNT(DISTINCT p.productModel) AS `count`,
        GROUP_CONCAT(DISTINCT a.AccountID) AS `name`,
        CONCAT(CAST(0+CAST(IFNULL(ROUND(SUM(
        IF (
        TIMESTAMPDIFF(
        DAY,
        SUBSTRING_INDEX(p.listingDate, ' ', 1),
        p.serviceManualTime
        ) &lt;= 7
        AND TIMESTAMPDIFF(
        DAY,
        SUBSTRING_INDEX(p.listingDate, ' ', 1),
        p.manualTime
        ) &lt;= 7,
        1,
        0
        )
        ) / COUNT(*) * 100,
        2),0) AS CHAR)AS CHAR),'%') AS completionRate
        FROM
        t_user_type u
        LEFT JOIN t_product_information p ON p.productTypeCode = u.typeId
        LEFT JOIN hrm_db.t_hrm_accountinfo a ON a.AccountID = u.userId
        WHERE p.listingDate IS NOT NULL AND p.listingDate != "" AND p.systemState = "已启用"
        <if test="time != '' and time != null">
            AND SUBSTRING_INDEX(p.listingDate, '-', 2) = #{time}
        </if>
        <if test="list != null and list.size > 0">
            AND p.productTypeCode IN
            <foreach collection="list" item="productTypeCode" open="(" separator="," close=")">
                #{productTypeCode}
            </foreach>
        </if>
        GROUP BY p.productCategoryCode
        )tt
        LEFT JOIN hrm_db.t_hrm_accountinfo htha ON ( INSTR( tt.`name`, htha.AccountID ))
        WHERE 1 = 1
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '0'.toString()">
            AND tt.productCategory = #{productCategory.value}
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '1'.toString()">
            AND tt.productCategory LIKE CONCAT('%',#{productCategory.value},'%')
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '2'.toString()">
            AND tt.productCategory &lt;&gt; #{productCategory.value}
        </if>
        <if test="name != '' and name!= null and name.textType != '' and name.textType != null and name.textType == '0'.toString()">
            AND tt.name = #{name.value}
        </if>
        <if test="name != '' and name!= null and name.textType != '' and name.textType != null and name.textType == '1'.toString()">
            AND tt.name LIKE CONCAT('%',#{name.value},'%')
        </if>
        <if test="name != '' and name!= null and name.textType != '' and name.textType != null and name.textType == '2'.toString()">
            AND tt.name &lt;&gt; #{name.value}
        </if>
        <if test="completionRate != '' and completionRate!= null and completionRate.numberType != '' and completionRate.numberType != null">
            AND tt.completionRate ${completionRate.numberType} #{completionRate.value}+0
        </if>
        <if test="count != '' and count!= null and count.numberType != '' and count.numberType != null">
            AND tt.`count` ${count.numberType} #{count.value}+0
        </if>
        GROUP BY
        tt.`name`,tt.productCategoryCode
        <if test="completionRate != '' and completionRate!= null and completionRate.sort != '' and completionRate.sort != null">
            ORDER BY 0+tt.completionRate ${completionRate.sort}
        </if>
        <if test="count != '' and count!= null and count.sort != '' and count.sort != null">
            ORDER BY 0+tt.`count` ${count.sort}
        </if>
        <if test="completionRate.sort == '' and count.sort == ''">
            ORDER BY tt.productCategoryCode DESC
        </if>
        <if test="number > 0">
            LIMIT #{number}
        </if>
    </select>

    <select id="selectCompletionRateByCategory" parameterType ="utry.data.modular.technicalQuality.dto.CompletionRateByCategoryQueryDTO" resultType="utry.data.modular.technicalQuality.dto.CompletionRateByCategoryDTO">
        SELECT
        tt.*
        FROM
        (
        SELECT
        p.productType,
        p.productModel,
        GROUP_CONCAT(a.RealName) AS `name`,
        SUBSTRING_INDEX(p.listingDate, ' ', 1) AS listingDate,
        SUBSTRING_INDEX(p.manualTime, ' ', 1) AS manualTime,
        SUBSTRING_INDEX(p.serviceManualTime, ' ', 1) AS serviceManualTime,
        IF (
        TIMESTAMPDIFF(
        DAY,
        SUBSTRING_INDEX(p.listingDate, ' ', 1),
        p.serviceManualTime
        ) &lt;= 7
        AND TIMESTAMPDIFF(
        DAY,
        SUBSTRING_INDEX(p.listingDate, ' ', 1),
        p.manualTime
        ) &lt;= 7,
        'Y',
        'N'
        ) AS flag
        FROM
        t_user_type u
        LEFT JOIN t_product_information p ON p.productTypeCode = u.typeId
        LEFT JOIN hrm_db.t_hrm_accountinfo a ON a.AccountID = u.userId
        WHERE p.listingDate IS NOT NULL AND p.systemState = "已启用"
        AND p.listingDate != ""
        AND p.productCategoryCode = #{productCategoryCode}
        <if test="time != '' and time != null">
            AND SUBSTRING_INDEX(p.listingDate, '-', 2) = #{time}
        </if>
        <if test="list != null and list.size > 0">
            AND p.productTypeCode IN
            <foreach collection="list" item="productTypeCode" open="(" separator="," close=")">
                #{productTypeCode}
            </foreach>
        </if>
        GROUP BY
        p.productModel
        ) tt
        WHERE 1 = 1
        <if test="productType != '' and productType!= null and productType.textType != '' and productType.textType != null and productType.textType == '0'.toString()">
            AND tt.productType = #{productType.value}
        </if>
        <if test="productType != '' and productType!= null and productType.textType != '' and productType.textType != null and productType.textType == '1'.toString()">
            AND tt.productType LIKE CONCAT('%',#{productCategory.value},'%')
        </if>
        <if test="productType != '' and productType!= null and productType.textType != '' and productType.textType != null and productType.textType == '2'.toString()">
            AND tt.productType &lt;&gt; #{productCategory.value}
        </if>
        <if test="name != '' and name!= null and name.textType != '' and name.textType != null and name.textType == '0'.toString()">
            AND tt.name = #{name.value}
        </if>
        <if test="name != '' and name!= null and name.textType != '' and name.textType != null and name.textType == '1'.toString()">
            AND tt.name LIKE CONCAT('%',#{name.value},'%')
        </if>
        <if test="name != '' and name!= null and name.textType != '' and name.textType != null and name.textType == '2'.toString()">
            AND tt.name &lt;&gt; #{name.value}
        </if>
        <if test="productModel != '' and productModel!= null and productModel.textType != '' and productModel.textType != null and productModel.textType == '0'.toString()">
            AND tt.productModel = #{productModel.value}
        </if>
        <if test="productModel != '' and productModel!= null and productModel.textType != '' and productModel.textType != null and productModel.textType == '1'.toString()">
            AND tt.productModel LIKE CONCAT('%',#{productModel.value},'%')
        </if>
        <if test="productModel != '' and productModel!= null and productModel.textType != '' and productModel.textType != null and productModel.textType == '2'.toString()">
            AND tt.productModel &lt;&gt; #{productModel.value}
        </if>
        <if test="listingDate != null and listingDate.type != '' and listingDate.type != null and listingDate.type=='0'.toString()">
            AND SUBSTRING_INDEX(listingDate, ' ', 1) <![CDATA[ >= ]]> #{listingDate.startDate} AND SUBSTRING_INDEX(listingDate, ' ', 1) <![CDATA[ <= ]]> #{listingDate.endDate}
        </if>
        <if test="listingDate != null and listingDate.type != '' and listingDate.type != null and listingDate.type=='1'.toString()">
            AND SUBSTRING_INDEX(listingDate, ' ', 1) <![CDATA[ <= ]]> #{listingDate.startDate}
        </if>
        <if test="listingDate != null and listingDate.type != '' and listingDate.type != null and listingDate.type=='2'.toString()">
            AND SUBSTRING_INDEX(listingDate, ' ', 1) <![CDATA[ >= ]]> #{listingDate.startDate}
        </if>
        <if test="listingDate != null and listingDate.type != '' and listingDate.type != null and listingDate.type=='3'.toString()">
            AND SUBSTRING_INDEX(listingDate, ' ', 1) = #{listingDate.startDate}
        </if>
        <if test="manualTime != null and manualTime.type != '' and manualTime.type != null and manualTime.type=='0'.toString()">
            AND SUBSTRING_INDEX(manualTime, ' ', 1) <![CDATA[ >= ]]> #{manualTime.startDate} AND SUBSTRING_INDEX(manualTime, ' ', 1) <![CDATA[ <= ]]> #{manualTime.endDate}
        </if>
        <if test="manualTime != null and manualTime.type != '' and manualTime.type != null and manualTime.type=='1'.toString()">
            AND SUBSTRING_INDEX(manualTime, ' ', 1) <![CDATA[ <= ]]> #{manualTime.startDate}
        </if>
        <if test="manualTime != null and manualTime.type != '' and manualTime.type != null and manualTime.type=='2'.toString()">
            AND SUBSTRING_INDEX(manualTime, ' ', 1) <![CDATA[ >= ]]> #{manualTime.startDate}
        </if>
        <if test="manualTime != null and manualTime.type != '' and manualTime.type != null and manualTime.type=='3'.toString()">
            AND SUBSTRING_INDEX(manualTime, ' ', 1) = #{manualTime.startDate}
        </if>
        <if test="serviceManualTime != null and serviceManualTime.type != '' and serviceManualTime.type != null and serviceManualTime.type=='0'.toString()">
            AND SUBSTRING_INDEX(serviceManualTime, ' ', 1) <![CDATA[ >= ]]> #{serviceManualTime.startDate} AND SUBSTRING_INDEX(serviceManualTime, ' ', 1) <![CDATA[ <= ]]> #{serviceManualTime.endDate}
        </if>
        <if test="serviceManualTime != null and serviceManualTime.type != '' and serviceManualTime.type != null and serviceManualTime.type=='1'.toString()">
            AND SUBSTRING_INDEX(serviceManualTime, ' ', 1) <![CDATA[ <= ]]> #{serviceManualTime.startDate}
        </if>
        <if test="serviceManualTime != null and serviceManualTime.type != '' and serviceManualTime.type != null and serviceManualTime.type=='2'.toString()">
            AND SUBSTRING_INDEX(serviceManualTime, ' ', 1) <![CDATA[ >= ]]> #{serviceManualTime.startDate}
        </if>
        <if test="serviceManualTime != null and serviceManualTime.type != '' and serviceManualTime.type != null and serviceManualTime.type=='3'.toString()">
            AND SUBSTRING_INDEX(serviceManualTime, ' ', 1) = #{serviceManualTime.startDate}
        </if>
        <if test="listingDate != '' and listingDate!= null and listingDate.sort != '' and listingDate.sort != null">
            ORDER BY tt.listingDate ${listingDate.sort}
        </if>
        <if test="manualTime != '' and manualTime!= null and manualTime.sort != '' and manualTime.sort != null">
            ORDER BY tt.manualTime ${manualTime.sort}
        </if>
        <if test="serviceManualTime != '' and serviceManualTime!= null and serviceManualTime.sort != '' and serviceManualTime.sort != null">
            ORDER BY tt.serviceManualTime ${serviceManualTime.sort}
        </if>
        <if test="listingDate.sort == '' and manualTime.sort == '' and serviceManualTime.sort == ''">
            ORDER BY tt.listingDate DESC
        </if>
        <if test="number > 0">
            LIMIT #{number}
        </if>
    </select>

    <select id="selectServiceList" parameterType ="utry.data.modular.technicalQuality.dto.RepairRateQueryDTO" resultType="utry.data.modular.technicalQuality.dto.RepairRateDTO">
        SELECT tt.*
        FROM
        (
        SELECT
        CASE
        WHEN a.systemState="已上门" AND a.pendingState="挂单" THEN "已挂单"
        WHEN a.systemState="已上门" AND a.pendingState="解挂" THEN "已解挂"
        ELSE
        a.systemState
        END AS systemState,
        CASE
        WHEN a.systemState="已上门" AND a.pendingState="挂单" THEN TIMESTAMPDIFF(SECOND,a.updateTime,NOW())
        WHEN a.systemState="已上门" AND a.pendingState="解挂" THEN TIMESTAMPDIFF(SECOND,a.updateTime,NOW())
        WHEN a.systemState="已上门" AND a.pendingState IS NULL THEN TIMESTAMPDIFF(SECOND,a.updateTime,NOW())
        ELSE
        NULL
        END AS time,
        CASE
        WHEN a.serviceType= '维修' AND a.visitTime IS NOT NULL THEN 1
        WHEN a.serviceType= '非上门维修' THEN 1
        ELSE
        0
        END
        +IFNULL(a.towUp,0) AS visitsNumber,
        a.dispatchingOrder,
        a.engineerName,
        a.engineerId,
        a.storeName,
        a.productCategory,
        a.dispatchingTime,
        a.appointmentTime,
        a.finishTime,
        a.accountingArea,
        a.repairEligible,
        a.provinces AS area,
        a.serviceType,
        TIMESTAMPDIFF(
        SECOND,
        a.dispatchingTime,
        IFNULL(a.TATFinishTime,NOW())
        ) AS turnoverTime
        FROM t_region_dispatching_detail a
        WHERE a.serviceType IN ("非上门维修", "维修")
        AND a.systemState IN ('已上门','已完成','已提交')
        AND a.dispatchingSource NOT IN (
        '自接',
        '营销中心',
        '前置渠道'
        )
        <if test="(list != null and list.size > 0) or (modelList != null and modelList.size > 0 ) or (productCategoryList != null and productCategoryList.size > 0)">
            AND( 1=2
            <if test="list != null and list.size > 0">
                OR a.productTypeCode IN
                <foreach collection="list" item="productTypeCode" open="(" separator="," close=")">
                    #{productTypeCode}
                </foreach>
            </if>
            <if test="modelList != null and modelList.size > 0">
                OR a.productModel IN
                <foreach collection="modelList" item="productModel" open="(" separator="," close=")">
                    #{productModel}
                </foreach>
            </if>
            <if test="productCategoryList != null and productCategoryList.size > 0">
                OR a.productCategoryCode IN
                <foreach collection="productCategoryList" item="productCategoryCode" open="(" separator="," close=")">
                    #{productCategoryCode}
                </foreach>
            </if>
            )
        </if>
        <if test="startTime != '' and startTime != null">
            AND a.dispatchingTime &gt;= #{startTime}
        </if>
        <if test="endTime != '' and endTime != null">
            AND a.dispatchingTime &lt;= #{endTime}
        </if>
        )tt
        WHERE 1 = 1
        <if test="engineerId != '' and engineerId!= null">
            AND tt.engineerId = #{engineerId}
        </if>
        <if test="ifException != '' and ifException!= null and ifException != '-1'.toString()">
            AND if(tt.serviceType = '维修',tt.visitsNumber &gt; 2,tt.visitsNumber &gt;= 2)
        </if>
        <if test="dispatchingOrder != '' and dispatchingOrder!= null and dispatchingOrder.textType != '' and dispatchingOrder.textType != null and dispatchingOrder.textType == '0'.toString()">
            AND tt.dispatchingOrder = #{dispatchingOrder.value}
        </if>
        <if test="dispatchingOrder != '' and dispatchingOrder!= null and dispatchingOrder.textType != '' and dispatchingOrder.textType != null and dispatchingOrder.textType == '1'.toString()">
            AND tt.dispatchingOrder LIKE CONCAT('%',#{dispatchingOrder.value},'%')
        </if>
        <if test="dispatchingOrder != '' and dispatchingOrder!= null and dispatchingOrder.textType != '' and dispatchingOrder.textType != null and dispatchingOrder.textType == '2'.toString()">
            AND tt.dispatchingOrder &lt;&gt; #{dispatchingOrder.value}
        </if>
        <if test="storeName != '' and storeName!= null and storeName.textType != '' and storeName.textType != null and storeName.textType == '0'.toString()">
            AND tt.storeName = #{storeName.value}
        </if>
        <if test="storeName != '' and storeName!= null and storeName.textType != '' and storeName.textType != null and storeName.textType == '1'.toString()">
            AND tt.storeName LIKE CONCAT('%',#{storeName.value},'%')
        </if>
        <if test="storeName != '' and storeName!= null and storeName.textType != '' and storeName.textType != null and storeName.textType == '2'.toString()">
            AND tt.storeName &lt;&gt; #{storeName.value}
        </if>
        <if test="engineerName != '' and engineerName!= null and engineerName.textType != '' and engineerName.textType != null and engineerName.textType == '0'.toString()">
            AND tt.engineerName = #{engineerName.value}
        </if>
        <if test="engineerName != '' and engineerName!= null and engineerName.textType != '' and engineerName.textType != null and engineerName.textType == '1'.toString()">
            AND tt.engineerName LIKE CONCAT('%',#{engineerName.value},'%')
        </if>
        <if test="engineerName != '' and engineerName!= null and engineerName.textType != '' and engineerName.textType != null and engineerName.textType == '2'.toString()">
            AND tt.engineerName &lt;&gt; #{engineerName.value}
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '0'.toString()">
            AND tt.productCategory = #{productCategory.value}
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '1'.toString()">
            AND tt.productCategory LIKE CONCAT('%',#{productCategory.value},'%')
        </if>
        <if test="productCategory != '' and productCategory!= null and productCategory.textType != '' and productCategory.textType != null and productCategory.textType == '2'.toString()">
            AND tt.productCategory &lt;&gt; #{productCategory.value}
        </if>
        <if test="accountingArea != '' and accountingArea!= null and accountingArea.textType != '' and accountingArea.textType != null and accountingArea.textType == '0'.toString()">
            AND tt.accountingArea = #{accountingArea.value}
        </if>
        <if test="accountingArea != '' and accountingArea!= null and accountingArea.textType != '' and accountingArea.textType != null and accountingArea.textType == '1'.toString()">
            AND tt.accountingArea LIKE CONCAT('%',#{accountingArea.value},'%')
        </if>
        <if test="accountingArea != '' and accountingArea!= null and accountingArea.textType != '' and accountingArea.textType != null and accountingArea.textType == '2'.toString()">
            AND tt.accountingArea &lt;&gt; #{accountingArea.value}
        </if>
        <if test="area != '' and area!= null and area.textType != '' and area.textType != null and area.textType == '0'.toString()">
            AND tt.area = #{area.value}
        </if>
        <if test="area != '' and area!= null and area.textType != '' and area.textType != null and area.textType == '1'.toString()">
            AND tt.area LIKE CONCAT('%',#{area.value},'%')
        </if>
        <if test="area != '' and area!= null and area.textType != '' and area.textType != null and area.textType == '2'.toString()">
            AND tt.area &lt;&gt; #{area.value}
        </if>
        <if test="serviceType != '' and serviceType!= null and serviceType.textType != '' and serviceType.textType != null and serviceType.textType == '0'.toString()">
            AND tt.serviceType = #{serviceType.value}
        </if>
        <if test="serviceType != '' and serviceType!= null and serviceType.textType != '' and serviceType.textType != null and serviceType.textType == '1'.toString()">
            AND tt.serviceType LIKE CONCAT('%',#{serviceType.value},'%')
        </if>
        <if test="serviceType != '' and serviceType!= null and serviceType.textType != '' and serviceType.textType != null and serviceType.textType == '2'.toString()">
            AND tt.serviceType &lt;&gt; #{serviceType.value}
        </if>
        <if test="systemState != '' and systemState!= null and systemState.textType != '' and systemState.textType != null and systemState.textType == '0'.toString()">
            AND tt.systemState = #{systemState.value}
        </if>
        <if test="systemState != '' and systemState!= null and systemState.textType != '' and systemState.textType != null and systemState.textType == '1'.toString()">
            AND tt.systemState LIKE CONCAT('%',#{systemState.value},'%')
        </if>
        <if test="systemState != '' and systemState!= null and systemState.textType != '' and systemState.textType != null and systemState.textType == '2'.toString()">
            AND tt.systemState &lt;&gt; #{systemState.value}
        </if>
        <if test="dispatchingTime != null and dispatchingTime.type != '' and dispatchingTime.type != null and dispatchingTime.type=='0'.toString()">
            AND tt.dispatchingTime <![CDATA[ >= ]]> #{dispatchingTime.startDate} AND tt.dispatchingTime <![CDATA[ <= ]]> #{dispatchingTime.endDate}
        </if>
        <if test="dispatchingTime != null and dispatchingTime.type != '' and dispatchingTime.type != null and dispatchingTime.type=='1'.toString()">
            AND tt.dispatchingTime <![CDATA[ <= ]]> #{dispatchingTime.startDate}
        </if>
        <if test="dispatchingTime != null and dispatchingTime.type != '' and dispatchingTime.type != null and dispatchingTime.type=='2'.toString()">
            AND tt.dispatchingTime <![CDATA[ >= ]]> #{dispatchingTime.startDate}
        </if>
        <if test="dispatchingTime != null and dispatchingTime.type != '' and dispatchingTime.type != null and dispatchingTime.type=='3'.toString()">
            AND tt.dispatchingTime = #{dispatchingTime.startDate}
        </if>
        <if test="appointmentTime != null and appointmentTime.type != '' and appointmentTime.type != null and appointmentTime.type=='0'.toString()">
            AND tt.appointmentTime <![CDATA[ >= ]]> #{appointmentTime.startDate} AND tt.appointmentTime <![CDATA[ <= ]]> #{appointmentTime.endDate}
        </if>
        <if test="appointmentTime != null and appointmentTime.type != '' and appointmentTime.type != null and appointmentTime.type=='1'.toString()">
            AND tt.appointmentTime <![CDATA[ <= ]]> #{appointmentTime.startDate}
        </if>
        <if test="appointmentTime != null and appointmentTime.type != '' and appointmentTime.type != null and appointmentTime.type=='2'.toString()">
            AND tt.appointmentTime <![CDATA[ >= ]]> #{appointmentTime.startDate}
        </if>
        <if test="appointmentTime != null and appointmentTime.type != '' and appointmentTime.type != null and appointmentTime.type=='3'.toString()">
            AND tt.appointmentTime = #{appointmentTime.startDate}
        </if>
        <if test="finishTime != '' and finishTime!= null and finishTime.numberType != '' and finishTime.numberType != null">
            AND tt.finishTime ${finishTime.numberType} #{finishTime.value}+0
        </if>
        <if test="turnoverTime != '' and turnoverTime!= null and turnoverTime.numberType != '' and turnoverTime.numberType != null">
            AND ROUND(tt.turnoverTime/3600) ${turnoverTime.numberType} #{turnoverTime.value}+0
        </if>
        <if test="visitsNumber != '' and visitsNumber!= null and visitsNumber.numberType != '' and visitsNumber.numberType != null">
            AND tt.visitsNumber ${visitsNumber.numberType} #{visitsNumber.value}+0
        </if>
        <if test="dispatchingTime != '' and dispatchingTime!= null and dispatchingTime.sort != '' and dispatchingTime.sort != null">
            ORDER BY tt.dispatchingTime ${dispatchingTime.sort}
        </if>
        <if test="appointmentTime != '' and appointmentTime!= null and appointmentTime.sort != '' and appointmentTime.sort != null">
            ORDER BY tt.appointmentTime ${appointmentTime.sort}
        </if>
        <if test="finishTime != '' and finishTime!= null and finishTime.sort != '' and finishTime.sort != null">
            ORDER BY tt.finishTime ${finishTime.sort}
        </if>
        <if test="turnoverTime != '' and turnoverTime!= null and turnoverTime.sort != '' and turnoverTime.sort != null">
            ORDER BY tt.turnoverTime ${turnoverTime.sort}
        </if>
        <if test="visitsNumber != '' and visitsNumber!= null and visitsNumber.sort != '' and visitsNumber.sort != null">
            ORDER BY 0+tt.visitsNumber ${visitsNumber.sort}
        </if>
        <if test="dispatchingTime.sort == '' and appointmentTime.sort == '' and finishTime.sort == '' and turnoverTime.sort == '' and visitsNumber.sort == ''">
            ORDER BY tt.dispatchingTime DESC
        </if>
        <if test="number > 0">
            LIMIT #{number}
        </if>
    </select>

    <select id="exportRepairRateByMonth" parameterType ="utry.data.modular.technicalQuality.dto.ExportConditionDTO" resultType="utry.data.modular.technicalQuality.dto.ExportRepairRateByMonthDTO">
        SELECT
        CONCAT(CAST(0+CAST(IFNULL(ROUND(t.eligible / t.total*100,2 ),0) AS CHAR)AS CHAR),'%') AS repairRate,
        SUBSTRING_INDEX(t.dispatchingTime, '-',2) AS `time`
        FROM
        (
        SELECT
        a.dispatchingTime,
        COUNT(a.dispatchingOrder) AS total,
        SUM(
        a.repairEligible
        ) AS eligible
        FROM
        t_region_dispatching_detail a
        WHERE a.serviceType IN ("非上门维修","维修") AND a.repairEligible IS NOT NULL AND a.systemState NOT IN ('已作废','已关闭','申请作废')
        AND a.dispatchingSource NOT IN ('自接','营销中心','前置渠道')
        <if test="(list != null and list.size > 0) or (modelList != null and modelList.size > 0 ) or (productCategoryList != null and productCategoryList.size > 0)">
            AND( 1=2
            <if test="list != null and list.size > 0">
                OR a.productTypeCode IN
                <foreach collection="list" item="productTypeCode" open="(" separator="," close=")">
                    #{productTypeCode}
                </foreach>
            </if>
            <if test="modelList != null and modelList.size > 0">
                OR a.productModel IN
                <foreach collection="modelList" item="productModel" open="(" separator="," close=")">
                    #{productModel}
                </foreach>
            </if>
            <if test="productCategoryList != null and productCategoryList.size > 0">
                OR a.productCategoryCode IN
                <foreach collection="productCategoryList" item="productCategoryCode" open="(" separator="," close=")">
                    #{productCategoryCode}
                </foreach>
            </if>
            )
        </if>
        <if test="startTime != '' and startTime != null">
            AND a.dispatchingTime &gt;= #{startTime}
        </if>
        <if test="endTime != '' and endTime != null">
            AND a.dispatchingTime &lt;= #{endTime}
        </if>
        <if test="productTypeCode != '' and productTypeCode != null">
            AND a.productTypeCode = #{productTypeCode}
        </if>
        AND a.dispatchingTime IS NOT NULL
        GROUP BY
        SUBSTRING_INDEX(a.dispatchingTime, '-',2)
        ) t
    </select>
</mapper>